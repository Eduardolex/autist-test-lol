<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GADS — Fully Automated Scoring</title>
  <style>
    :root { --bg:#0b0d10; --card:#12161c; --muted:#8ea0b2; --text:#e9eef5; --line:#223042; --accent:#6aa9ff; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; background:var(--bg); color:var(--text); }
    header { padding: 22px 16px; border-bottom: 1px solid var(--line); background: linear-gradient(180deg, #0f131a, #0b0d10); }
    h1 { margin:0 0 6px; font-size: 18px; font-weight: 650; }
    p { margin: 0; color: var(--muted); line-height: 1.35; }
    main { max-width: 1180px; margin: 0 auto; padding: 16px; display: grid; gap: 14px; grid-template-columns: 1.25fr .75fr; }
    @media (max-width: 980px) { main { grid-template-columns: 1fr; } }
    .card { background: var(--card); border: 1px solid var(--line); border-radius: 14px; padding: 14px; }
    .card h2 { margin: 0 0 10px; font-size: 15px; }
    .row { display: grid; gap: 10px; grid-template-columns: repeat(12, 1fr); }
    .field { grid-column: span 6; display:flex; flex-direction: column; gap: 6px; }
    .field.sm { grid-column: span 3; }
    label { font-size: 12px; color: var(--muted); }
    input[type="text"], textarea, select {
      width: 100%; padding: 10px 10px; border-radius: 10px;
      border: 1px solid #2a3a50; background:#0d1117; color:var(--text);
      outline: none;
    }
    textarea { min-height: 88px; resize: vertical; }
    details { border: 1px solid var(--line); border-radius: 14px; overflow: hidden; background: #10151c; }
    summary { cursor:pointer; padding: 12px 12px; font-weight: 650; list-style: none; display:flex; align-items:center; justify-content:space-between; }
    summary::-webkit-details-marker { display:none; }
    summary span { color: var(--muted); font-weight: 550; font-size: 12px; }
    .content { padding: 12px; border-top: 1px solid var(--line); }
    .scaleHelp { color: var(--muted); font-size: 12px; line-height: 1.4; margin-bottom: 10px; }
    .item { display:grid; grid-template-columns: 1fr auto; gap: 10px; padding: 10px; border: 1px solid #1f2b3b; border-radius: 12px; background:#0c1016; margin-bottom: 10px; }
    .item strong { font-size: 13px; }
    .radios { display:flex; gap: 8px; align-items:center; }
    .pill {
      display:inline-flex; align-items:center; gap:6px; padding: 6px 8px; border-radius: 999px;
      border: 1px solid #223042; background:#0b0f15; color: var(--muted); font-size: 12px;
    }
    .btns { display:flex; flex-wrap: wrap; gap: 10px; }
    button {
      padding: 10px 12px; border-radius: 12px; border: 1px solid #2a3a50; background:#0d1117; color:var(--text);
      cursor:pointer; font-weight: 650;
    }
    button.primary { border-color: #2d5aa3; background: rgba(106,169,255,.14); }
    button.danger { border-color: #7a2e2e; background: rgba(255,90,90,.10); }
    button:active { transform: translateY(1px); }
    .scoreGrid { display:grid; gap: 10px; grid-template-columns: 1fr; }
    .scoreBox { border: 1px solid #223042; border-radius: 12px; padding: 10px; background:#0c1016; }
    .scoreBox h3 { margin:0 0 8px; font-size: 13px; }
    .scoreLine { display:flex; justify-content: space-between; gap: 10px; color: var(--muted); font-size: 12px; }
    .scoreLine b { color: var(--text); font-weight: 700; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size: 12px; white-space: pre-wrap; }
    .warn { color: #ffcf66; }
    .ok { color: #8dffa0; }
  </style>
</head>
<body>
<header>
  <h1>GADS — Fully Automated Scoring</h1>
  <p>Section V (0–3) → Raw → SS → Sum SS → ADQ + Percentile + Interpretation.</p>
</header>

<main>
  <section class="card">
    <h2>Section I — Identifying Information</h2>
    <div class="row">
      <div class="field"><label>Name</label><input id="name" type="text" /></div>
      <div class="field sm"><label>Sex</label>
        <select id="sex"><option value="">—</option><option>Male</option><option>Female</option><option>Other</option></select>
      </div>
      <div class="field sm"><label>Subject Age</label><input id="age" type="text" /></div>
      <div class="field"><label>Address</label><input id="address" type="text" /></div>
      <div class="field"><label>Parents/Guardians</label><input id="guardians" type="text" /></div>
      <div class="field"><label>School</label><input id="school" type="text" /></div>
      <div class="field"><label>Examiner Name</label><input id="examiner" type="text" /></div>
      <div class="field"><label>Rater Name</label><input id="rater" type="text" /></div>
      <div class="field sm"><label>Date of Rating</label><input id="ratingDate" type="text" placeholder="YYYY-MM-DD" /></div>
      <div class="field sm"><label>DOB</label><input id="dob" type="text" placeholder="YYYY-MM-DD" /></div>
    </div>

    <details open>
      <summary>Section V — Response Form (0–3) <span id="secVsum"></span></summary>
      <div class="content">
        <div class="scaleHelp">
          <span class="pill">0 = never observed</span>
          <span class="pill">1 = seldom</span>
          <span class="pill">2 = sometimes</span>
          <span class="pill">3 = frequently</span>
        </div>
        <div id="secV"></div>
      </div>
    </details>

    <div class="btns" style="margin-top:12px;">
      <button class="primary" id="btnSave">Save</button>
      <button id="btnExport">Export JSON</button>
      <button id="btnPrint">Print</button>
      <button class="danger" id="btnClear">Clear All</button>
    </div>
  </section>

  <aside class="card">
    <h2>Automated Score Summary</h2>
    <div class="scoreGrid" id="scoreGrid"></div>

    <div class="card" style="margin-top:12px; padding:12px;">
      <h2 style="margin:0 0 8px;">Debug</h2>
      <div class="mono" id="debug"></div>
    </div>
  </aside>
</main>

<script>
  // -------------------- Section V Items --------------------
  const SEC_V = [
    {
      key: "social",
      title: "Social Interaction",
      items: [
        { id: 1, t: "Inattentive to social/environment cues" },
        { id: 2, t: "Difficulty cooperating in a group" },
        { id: 3, t: "Difficulty playing with peers" },
        { id: 4, t: "Unaware of common social rules/conventions" },
        { id: 5, t: "Limited empathy for others' feelings" },
        { id: 6, t: "Needs excessive reassurance when change/problems occur" },
        { id: 7, t: "Emotion expression lacks nuance (over/under-reacts)" },
        { id: 8, t: "Needs very specific instructions to start tasks" },
        { id: 9, t: "Shows frustration/anger inappropriately" },
        { id:10, t: "Gets frustrated quickly when requirements are unclear" },
      ]
    },
    {
      key: "restricted",
      title: "Restricted Patterns of Behavior",
      items: [
        { id:11, t: "Looks unhappy/unexcited when praised or entertained" },
        { id:12, t: "Insensitive to others' needs" },
        { id:13, t: "Eccentric/unusual behavior" },
        { id:14, t: "Intense preoccupation with specific subjects/objects" },
        { id:15, t: "Needs extensive direction from others" },
        { id:16, t: "Shows empathy in an odd/inappropriate way" },
        { id:17, t: "Clumsy/uncoordinated large-motor movements" },
        { id:18, t: "Unusual/uncoordinated movement when walking/running" },
      ]
    },
    {
      key: "cognitive",
      title: "Cognitive Patterns",
      items: [
        { id:19, t: "Talks about one topic excessively" },
        { id:20, t: "Appears unusually skilled/knowledgeable in specific areas" },
        { id:21, t: "Very precise/pedantic speech" },
        { id:22, t: "Interprets words very literally/concretely" },
        { id:23, t: "Difficulty understanding jokes/humor" },
        { id:24, t: "Excellent memory" },
        { id:25, t: "Intense/obsessive interest in intellectual topics" },
      ]
    },
    {
      key: "pragmatic",
      title: "Pragmatic Skills",
      items: [
        { id:26, t: "Difficulty understanding slang" },
        { id:27, t: "Difficulty recognizing teasing" },
        { id:28, t: "Difficulty recognizing ridicule/being made fun of" },
        { id:29, t: "Difficulty understanding why others may dislike them" },
        { id:30, t: "Poor prediction of likely outcomes in social situations" },
        { id:31, t: "Difficulty with pretend/make-believe play" },
        { id:32, t: "When confused, avoids clarifying and shifts to familiar topic" },
      ]
    }
  ];

  // -------------------- Norm Tables (from your screenshots) --------------------
  // Raw -> Standard Score (SS) ranges per subscale
  // (Numbers transcribed from the table you posted.)
  const RAW_TO_SS = {
    social: [
      [0, 9, 1],[10,11,2],[12,12,3],[13,14,4],[15,15,5],[16,17,6],[18,19,7],[20,20,8],
      [21,22,9],[23,23,10],[24,25,11],[26,26,12],[27,28,13],[29,30,14],
    ],
    restricted: [
      [0,1,1],[2,2,2],[3,4,3],[5,6,4],[7,7,5],[8,9,6],[10,11,7],[12,12,8],
      [13,14,9],[15,15,10],[16,17,11],[18,19,12],[20,20,13],[21,22,14],[23,23,15],[24,24,16],
    ],
    cognitive: [
      [0,3,1],[4,4,2],[5,5,3],[6,7,4],[8,8,5],[9,10,6],[11,11,7],[12,12,8],
      [13,14,9],[15,15,10],[16,17,11],[18,18,12],[19,19,13],[20,21,14],
    ],
    pragmatic: [
      [0,2,1],[3,3,2],[4,5,3],[6,6,4],[7,8,5],[9,9,6],[10,10,7],[11,12,8],
      [13,13,9],[14,14,10],[15,16,11],[17,17,12],[18,19,13],[20,20,14],[21,21,15],
    ],
  };

  // SS -> Percentile (rightmost column of your SS table)
  const SS_TO_PCT = {
    1: "<1", 2:"<1", 3:"1", 4:"2", 5:"5", 6:"9", 7:"16", 8:"25", 9:"37", 10:"50",
    11:"63", 12:"75", 13:"84", 14:"91", 15:"95", 16:"98", 17:"99", 18:">99", 19:">99", 20:">99"
  };

  // Sum of SS -> ADQ + Percentile (your ADQ table screenshot)
  // NOTE: screenshot is missing rows for SumSS 32..36, so those are interpolated placeholders.
  // Upload the page containing 32..36 and we’ll make them exact.
  const SUMSS_TO_ADQ = {
    9:  {adq:48,  pct:"<1"},
    10: {adq:50,  pct:"<1"},
    11: {adq:52,  pct:"<1"},
    12: {adq:53,  pct:"<1"},
    13: {adq:55,  pct:"<1"},
    14: {adq:57,  pct:"<1"},
    15: {adq:58,  pct:"<1"},
    16: {adq:60,  pct:"<1"},
    17: {adq:62,  pct:"<1"},
    18: {adq:63,  pct:"<1"},
    19: {adq:65,  pct:"1"},
    20: {adq:67,  pct:"1"},
    21: {adq:68,  pct:"1"},
    22: {adq:70,  pct:"2"},
    23: {adq:72,  pct:"3"},
    24: {adq:73,  pct:"3"},
    25: {adq:75,  pct:"5"},
    26: {adq:77,  pct:"6"},
    27: {adq:78,  pct:"7"},
    28: {adq:80,  pct:"9"},
    29: {adq:82,  pct:"12"},
    30: {adq:83,  pct:"13"},
    31: {adq:85,  pct:"16"},

    // Interpolated placeholders (because your screenshot omits these rows):
    32: {adq:87,  pct:"19"},
    33: {adq:88,  pct:"21"},
    34: {adq:90,  pct:"25"},
    35: {adq:92,  pct:"28"},
    36: {adq:93,  pct:"31"},

    37: {adq:95,  pct:"37"},
    38: {adq:97,  pct:"42"},
    39: {adq:98,  pct:"45"},
    40: {adq:100, pct:"50"},
    41: {adq:102, pct:"55"},
    42: {adq:103, pct:"58"},
    43: {adq:105, pct:"63"},
    44: {adq:107, pct:"68"},
    45: {adq:108, pct:"70"},
    46: {adq:110, pct:"75"},
    47: {adq:112, pct:"79"},
    48: {adq:113, pct:"81"},
    49: {adq:115, pct:"84"},
    50: {adq:117, pct:"87"},
    51: {adq:118, pct:"89"},
    52: {adq:120, pct:"91"},
    53: {adq:122, pct:"93"},
    54: {adq:123, pct:"94"},
    55: {adq:125, pct:"95"},
    56: {adq:127, pct:"97"},
    57: {adq:128, pct:"97"},
    58: {adq:130, pct:"98"},
    59: {adq:132, pct:"99"},
  };

  function adqBand(adq) {
    if (adq >= 80) return "High / Probable";
    if (adq >= 70) return "Borderline";
    return "Low / Not Probable";
  }

  // -------------------- State --------------------
  const defaultState = () => ({
    meta: { name:"", sex:"", age:"", address:"", guardians:"", school:"", examiner:"", rater:"", ratingDate:"", dob:"" },
    secV: Object.fromEntries(SEC_V.flatMap(s => s.items.map(it => [String(it.id), null]))),
  });
  let state = defaultState();

  // -------------------- Persistence --------------------
  const KEY = "gads_auto_full_v1";
  function load() {
    try {
      const raw = localStorage.getItem(KEY);
      if (!raw) return;
      const parsed = JSON.parse(raw);
      if (parsed && typeof parsed === "object") state = parsed;
    } catch {}
  }
  function save() {
    localStorage.setItem(KEY, JSON.stringify(state));
  }

  // -------------------- Helpers --------------------
  const $ = (id) => document.getElementById(id);

  function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  function lookupSS(subKey, raw) {
    const rows = RAW_TO_SS[subKey];
    for (const [lo, hi, ss] of rows) {
      if (raw >= lo && raw <= hi) return ss;
    }
    // if raw above max, return highest SS available for that subscale
    const maxSS = Math.max(...rows.map(r => r[2]));
    const maxHi = Math.max(...rows.map(r => r[1]));
    if (raw > maxHi) return maxSS;
    // if raw below min, return lowest
    return Math.min(...rows.map(r => r[2]));
  }

  function lookupADQ(sumSS) {
    if (SUMSS_TO_ADQ[sumSS]) return { ...SUMSS_TO_ADQ[sumSS], exact: !(sumSS>=32 && sumSS<=36) };
    // clamp if outside provided range
    const keys = Object.keys(SUMSS_TO_ADQ).map(Number).sort((a,b)=>a-b);
    if (sumSS < keys[0]) return { ...SUMSS_TO_ADQ[keys[0]], exact:false, clamped:true };
    if (sumSS > keys[keys.length-1]) return { ...SUMSS_TO_ADQ[keys[keys.length-1]], exact:false, clamped:true };
    // fallback: nearest
    let nearest = keys[0];
    for (const k of keys) if (Math.abs(k-sumSS) < Math.abs(nearest-sumSS)) nearest = k;
    return { ...SUMSS_TO_ADQ[nearest], exact:false, nearest:true };
  }

  // -------------------- Scoring --------------------
  function rawSubscaleSum(sub) {
    let sum = 0, answered = 0;
    for (const it of sub.items) {
      const v = state.secV[String(it.id)];
      if (v === null || v === undefined) continue;
      sum += v;
      answered++;
    }
    return { sum, answered, total: sub.items.length };
  }

  function compute() {
    const sub = {};
    let totalAnswered = 0, totalItems = 0;

    for (const s of SEC_V) {
      const r = rawSubscaleSum(s);
      const ss = (r.answered === r.total) ? lookupSS(s.key, r.sum) : null;
      sub[s.key] = {
        title: s.title,
        raw: r.sum,
        answered: r.answered,
        total: r.total,
        ss,
        ssPct: ss ? (SS_TO_PCT[ss] ?? "—") : "—",
      };
      totalAnswered += r.answered;
      totalItems += r.total;
    }

    const allComplete = Object.values(sub).every(x => x.answered === x.total);
    const sumSS = allComplete ? (sub.social.ss + sub.restricted.ss + sub.cognitive.ss + sub.pragmatic.ss) : null;

    const adqInfo = (sumSS !== null) ? lookupADQ(sumSS) : null;
    const adq = adqInfo ? adqInfo.adq : null;
    const adqPct = adqInfo ? adqInfo.pct : "—";
    const band = (adq !== null) ? adqBand(adq) : "—";

    return { sub, totalAnswered, totalItems, allComplete, sumSS, adq, adqPct, band, adqInfo };
  }

  // -------------------- Rendering --------------------
  function renderSectionV() {
    const root = $("secV");
    root.innerHTML = "";
    for (const sub of SEC_V) {
      const wrap = document.createElement("div");
      wrap.style.marginBottom = "12px";
      const h = document.createElement("div");
      h.innerHTML = `<div style="display:flex;align-items:center;justify-content:space-between;margin:8px 0 10px;">
        <strong style="font-size:14px;">${escapeHtml(sub.title)}</strong>
        <span class="pill">Raw total: <b id="raw_${sub.key}">0</b></span>
      </div>`;
      wrap.appendChild(h);

      for (const it of sub.items) {
        const row = document.createElement("div");
        row.className = "item";
        row.innerHTML = `
          <div>
            <strong>${it.id}.</strong> ${escapeHtml(it.t)}
          </div>
          <div class="radios" role="radiogroup" aria-label="Item ${it.id}">
            ${[0,1,2,3].map(v => `
              <label class="pill" style="cursor:pointer;">
                <input type="radio" name="v_${it.id}" value="${v}" style="accent-color: var(--accent);" />
                ${v}
              </label>
            `).join("")}
          </div>
        `;
        wrap.appendChild(row);

        const chosen = state.secV[String(it.id)];
        row.querySelectorAll(`input[name="v_${it.id}"]`).forEach(inp => {
          inp.checked = (chosen === Number(inp.value));
          inp.addEventListener("change", () => {
            state.secV[String(it.id)] = Number(inp.value);
            update(true);
          });
        });
      }
      root.appendChild(wrap);
    }
  }

  function bindMeta() {
    const map = [
      ["name","name"], ["sex","sex"], ["age","age"], ["address","address"], ["guardians","guardians"],
      ["school","school"], ["examiner","examiner"], ["rater","rater"], ["ratingDate","ratingDate"], ["dob","dob"]
    ];
    for (const [id,key] of map) {
      const el = $(id);
      el.value = state.meta[key] || "";
      el.addEventListener("input", () => { state.meta[key] = el.value; update(false); });
      el.addEventListener("change", () => { state.meta[key] = el.value; update(false); });
    }
  }

  function renderScores() {
    const c = compute();

    $("secVsum").textContent = `${c.totalAnswered}/${c.totalItems} rated`;

    for (const k of Object.keys(c.sub)) {
      const el = document.querySelector(`#raw_${k}`);
      if (el) el.textContent = c.sub[k].raw;
    }

    const grid = $("scoreGrid");
    grid.innerHTML = "";

    for (const key of ["social","restricted","cognitive","pragmatic"]) {
      const s = c.sub[key];
      const box = document.createElement("div");
      box.className = "scoreBox";
      box.innerHTML = `
        <h3>${escapeHtml(s.title)}</h3>
        <div class="scoreLine"><span>Raw subscale</span><b>${s.raw}</b></div>
        <div class="scoreLine"><span>Completion</span><b>${s.answered}/${s.total}</b></div>
        <div class="scoreLine"><span>Standard Score (SS)</span><b>${s.ss ?? "—"}</b></div>
        <div class="scoreLine"><span>SS Percentile</span><b>${s.ssPct}</b></div>
      `;
      grid.appendChild(box);
    }

    const total = document.createElement("div");
    total.className = "scoreBox";
    const adqNote = (c.adqInfo && c.adqInfo.exact === false && c.sumSS !== null && c.sumSS >= 32 && c.sumSS <= 36)
      ? `<div class="scoreLine"><span class="warn">Note</span><b class="warn">SumSS 32–36 row is interpolated</b></div>`
      : "";

    const completeBadge = c.allComplete ? `<span class="ok">complete</span>` : `<span class="warn">incomplete</span>`;

    total.innerHTML = `
      <h3>Overall</h3>
      <div class="scoreLine"><span>Section V status</span><b>${completeBadge}</b></div>
      <div class="scoreLine"><span>Sum of SS</span><b>${c.sumSS ?? "—"}</b></div>
      <div class="scoreLine"><span>ADQ</span><b>${c.adq ?? "—"}</b></div>
      <div class="scoreLine"><span>ADQ Percentile</span><b>${c.adqPct}</b></div>
      <div class="scoreLine"><span>Interpretation</span><b>${c.band}</b></div>
      ${adqNote}
    `;
    grid.appendChild(total);

    $("debug").textContent = JSON.stringify({ meta: state.meta, scores: c }, null, 2);
  }

  function update(doSave=true) {
    renderScores();
    if (doSave) save();
  }

  function download(filename, text) {
    const blob = new Blob([text], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  // -------------------- Boot --------------------
  load();
  renderSectionV();
  bindMeta();
  renderScores();

  $("btnSave").addEventListener("click", () => { save(); alert("Saved."); });
  $("btnExport").addEventListener("click", () => {
    const payload = { ...state, exportedAt: new Date().toISOString(), computed: compute() };
    download("gads_scored.json", JSON.stringify(payload, null, 2));
  });
  $("btnPrint").addEventListener("click", () => window.print());
  $("btnClear").addEventListener("click", () => {
    if (!confirm("Clear all saved data for this form on this browser?")) return;
    state = defaultState();
    save();
    location.reload();
  });
</script>
</body>
</html>
